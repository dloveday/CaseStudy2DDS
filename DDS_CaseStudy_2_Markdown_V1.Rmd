---
title: 'DDS 6306 - Case Study #2'
author: "David Loveday"
date: "4/11/2021"
output: html_document
---

```{r setup, include=FALSE, warning=FALSE, message=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning=FALSE, message=FALSE )
```

## Youtube Presentation Link: https://www.youtube.com/watch?v=wSlwNIm8y2M

## GitHub Webpage Link: https://dloveday.github.io/

## Executive Summary
DDSAnalytics has concluded an initial analysis of employee attribute data which demonstrates the ability to predict, using a naïve Bayes classification model, an individual employee’s voluntary attrition potential, as well as their monthly income using a multiple linear regression model.  Many of these explanatory attributes may already exist in employee files while the others could be easily, and cost-effectively, be collected.

The analysis found these independent variables to be most impactful and their specific demographic values to be most at-risk for attrition:

(1) Does the employee work overtime?  			        Most At-Risk: “Yes”
(2) Employee’s total years with the Company			    Most At-Risk:  0 – 10
(3) Employee’s martial status				                Most At-Risk:  “Single”
(4) Employee’s tenure in their current role			    Most At-Risk:  0 - 4
(5) Monthly Income					                        Most At-Risk: $0 - $5,811
(6) Department in which employee works			        Most At-Risk: “Sales”
(7) Role held by the employee				                Most At-Risk: “Sales Rep”
(8) Age of employee					                        Most At-Risk: 18 – 28
(9) Employee’s tenure with their current manager		Most At-Risk: 0 - 4

DDSAnalytics has also found that a relatively simple multiple linear regression (MLR) model can effectively describe, and predict, an employee’s monthly income.

The MLR model below achieves a statistically significant (p-value << 0.05) solution with an Adjusted R2 = 91%.

𝑴𝒐𝒏𝒕𝒉𝒍𝒚𝑰𝒏𝒄𝒐𝒎𝒆= 𝜷𝟎+𝜷𝟏𝑫𝒊𝒔𝒕𝒂𝒏𝒄𝒆+𝜷𝟐𝑱𝒐𝒃𝑳𝒆𝒗𝒆𝒍+𝜷𝟑𝑷𝒆𝒓𝒄𝑺𝒂𝒍𝒂𝒓𝒚𝑯𝒊𝒌𝒆+𝜷𝟒𝑻𝒐𝒕𝒂𝒍𝑾𝒐𝒓𝒌𝒊𝒏𝒈𝒀𝒆𝒂𝒓𝒔+𝜷𝟓𝒀𝒆𝒂𝒓𝒔𝑾𝒊𝒕𝒉𝑪𝒖𝒓𝒓𝒆𝒏𝒕𝑴𝒂𝒏𝒂𝒈𝒆𝒓

Residuals:
   	  Min        1Q       Median     3Q       Max 
 	   -5759      -872        16       740     4035

Coefficients:
                    	            Estimate 	Std. Error    t value 	 Pr(>|t|)    
𝜷𝟎 (Intercept)          	      -1707.30   227.30        -7.51  	 1.5e-13
𝜷𝟏  DistanceFromHome            -15.57      5.74         -2.71   	 0.0068 
𝜷𝟐  JobLevel              	    3723.77     68.43        54.41  	 < 2e-16
𝜷𝟑  PercentSalaryHike            9.57      	12.72         0.75    	0.4519    
𝜷𝟒  TotalWorkingYears           68.12      	10.41         6.54  	 1.0e-10
𝜷𝟓  YearsWithCurrManager       -60.04      	14.70        -4.09  	 4.8e-05

Residual standard error: 1370 on 864 degrees of freedom
Multiple R-squared:  0.911,	Adjusted R-squared:  0.911 
F-statistic: 1.78e+03 on 5 and 864 DF,  	p-value: <2e-16

## Project Desciption
Talent management is defined as the iterative process of developing and retaining employees. It may include workforce planning, employee training programs, identifying high-potential employees and reducing/preventing voluntary employee turnover (attrition). To gain a competitive edge over its competition, DDSAnalytics is planning to leverage data science for talent management. The executive leadership has identified predicting employee turnover as its first application of data science for talent management. Before the business green lights the project, they have tasked your data science team to conduct an analysis of existing employee data. 

## Project Deliverables
(1) Identify the top factors which contribute tot turnover.  Clearly document and defend the analysis.
(2) Discuss any other material insights, trends, or observations gleaned from the dataset.
(3) Construct models which predict attrition and monthly income

## Dataset Description
The dataset provided to the project team captures general demographic information for each employee (example: age, gender, marital status) company-specific information (example: total years with the company, department, role), along with employee-reported satisfaction scores for several areas (example: Work Life Balance, Environment Satisfaction).

 - Total rows: 870
 - Total gross/net columns: 36/32
     -- ID/EmployeeCount/Over18/StandardHours [Columns with singular values removed from the analysis]

 - Character/Categorical Fields: 8
 - Numeric Fields: 24
     -- 10 integer fields behave more as categorical variables

Mercifully, the dataset did not contain any missing or null values

######################
## WORKFLOW & OUTPUTS
######################

## Initialize libraries
```{r}
library(ggplot2)
library(tidyverse)
library(dplyr)
library(tidyr)
library(maps)
library(ggthemes)
library(plotly)
library(reshape)
library(githubinstall)
library(envirofacts)
library(eia)
library(stringr)
library(mapproj)
library(countrycode)
library(WDI)
library(stringr)
library(jsonlite)
library(plyr)
library(Rmisc)
library(class)
library(caret)
library(e1071)
library(scales)
library(RCurl) #getURL
library(rvest) #html_table, html_node
library(maps)
library(fiftystater)
library(mapproj)
library(GGally)
library(fpp)
library(shiny)
library(psych)
library(Hmisc)
library(corrplot)
library(caTools)
library(rpart)
library(data.table)
library(DT)
library(gridExtra)
library(Metrics)
library(randomForest)
library(pROC)
library(car)
library(asbio)
library(boot)
library(DAAG)
library(olsrr)
```

## Import Data / Format & Condition
```{r}
path.employee.dB <- "C:\\Users\\dloveday\\Dropbox\\Family\\School\\SMU\\Courses\\Spring 2021\\DS 6306 - Doing Data Science\\Lecture Notes\\Unit 14 and 15 Case Study 2\\CaseStudy2-data.csv"

make.eda.plots <- "Yes"
  column.histograms <- "Yes"
  demographics.plots <- "Yes"
  correlation.matrix.plots <- "Yes"
#
######################## FORMAT & CONDITION dB ########################
#
employee.dB <- read.csv(path.employee.dB)
raw.employe.dB <- read.csv(path.employee.dB)
```

## Data Diagnostics
```{r}
count.duplicates <- sum(duplicated(employee.dB))
summary.employee.dB <- summary(employee.dB)
```

## Variable Conversions, Numericizations & Factorizations
```{r}
# Make corresponding numeric field for "Attrition", if 'Yes' (= 1), if 'No' (= 0)
employee.dB$Attrition.Numeric <- ifelse(employee.dB$Attrition == "Yes", 1, 0)

# Make corresponding numeric field for "BusinessTravel"
employee.dB$BusinessTravel.Non_Travel <- ifelse(employee.dB$BusinessTravel == "Non-Travel", 1, 0)
employee.dB$BusinessTravel.Travel_Rarely <- ifelse(employee.dB$BusinessTravel == "Travel_Rarely", 1, 0)
employee.dB$BusinessTravel.Travel_Frequently <- ifelse(employee.dB$BusinessTravel == "Travel_Frequently", 1, 0)

# Make corresponding numeric field for "Department"
employee.dB$Department.Sales <- ifelse(employee.dB$Department == "Sales", 1, 0)
employee.dB$Department.Research_Development <- ifelse(employee.dB$Department == "Research & Development", 1, 0)
employee.dB$Department.Human_Resources <- ifelse(employee.dB$Department == "Human Resources", 1, 0)

# Make corresponding numeric field for "EducationalField"
employee.dB$EducationField.LifeSciences <- ifelse(employee.dB$EducationField == "Life Sciences", 1, 0)
employee.dB$EducationField.Medical <- ifelse(employee.dB$EducationField == "Medical", 1, 0)
employee.dB$EducationField.Marketing <- ifelse(employee.dB$EducationField == "Marketing", 1, 0)
employee.dB$EducationField.TechnicalDegree <- ifelse(employee.dB$EducationField == "Technical Degree", 1, 0)
employee.dB$EducationField.Other <- ifelse(employee.dB$EducationField == "Other", 1, 0)
employee.dB$EducationField.HumanResources <- ifelse(employee.dB$EducationField == "Human Resources", 1, 0)

# Make corresponding numeric field for "Gender"
for (i in 1:nrow(employee.dB)){
  if(employee.dB$Gender[i] == "Male") (employee.dB$Gender.Numeric[i] <- 0)
  if(employee.dB$Gender[i] == "Female") (employee.dB$Gender.Numeric[i] <- 1)
}

# Make corresponding numeric field for "JobRole"
employee.dB$JobRole.SalesExecutive <- ifelse(employee.dB$JobRole == "Sales Executive", 1, 0)
employee.dB$JobRole.ResearchDirector <- ifelse(employee.dB$JobRole == "Research Director", 1, 0)
employee.dB$JobRole.ManufacturingDirector <- ifelse(employee.dB$JobRole == "Manufacturing Director", 1, 0)
employee.dB$JobRole.ResearchScientist <- ifelse(employee.dB$JobRole == "Research Scientist", 1, 0)
employee.dB$JobRole.SalesRepresentative <- ifelse(employee.dB$JobRole == "Sales Representative", 1, 0)
employee.dB$JobRole.HealthcareRepresentative <- ifelse(employee.dB$JobRole == "Healthcare Representative", 1, 0)
employee.dB$JobRole.Manager <- ifelse(employee.dB$JobRole == "Manager", 1, 0)
employee.dB$JobRole.HumanResources <- ifelse(employee.dB$JobRole == "Human Resources", 1, 0)
employee.dB$JobRole.LaboratoryTechnician <- ifelse(employee.dB$JobRole == "Laboratory Technician", 1, 0)

# Make corresponding numeric field for "MaritalStatus"
employee.dB$MaritalStatus.Divorced <- ifelse(employee.dB$MaritalStatus == "Divorced", 1, 0)
employee.dB$MaritalStatus.Single <- ifelse(employee.dB$MaritalStatus == "Single", 1, 0)
employee.dB$MaritalStatus.Married <- ifelse(employee.dB$MaritalStatus == "Married", 1, 0)

# Make corresponding numeric field for "OverTime"
for (i in 1:nrow(employee.dB)){
  if(employee.dB$OverTime[i] == "No") (employee.dB$OverTime.Numeric[i] <- 0)
  if(employee.dB$OverTime[i] == "Yes") (employee.dB$OverTime.Numeric[i] <- 1)
}



categorical.string.variables <- c("BusinessTravel", "Department", "EducationField", "Gender", "JobRole", "MaritalStatus", "OverTime")

categorical.string.binary.variables <- c("BusinessTravel.Non_Travel", "BusinessTravel.Travel_Rarely", "BusinessTravel.Travel_Frequently",
                                         "Department.Sales", "Department.Research_Development", "Department.Human_Resources",
                                         "EducationField.LifeSciences", "EducationField.Medical", "EducationField.Marketing", "EducationField.TechnicalDegree", "EducationField.Other", "EducationField.HumanResources",
                                         "Gender.Numeric", 
                                         "JobRole.SalesExecutive", "JobRole.ResearchDirector", "JobRole.ManufacturingDirector", "JobRole.ResearchScientist", "JobRole.SalesRepresentative", "JobRole.HealthcareRepresentative", "JobRole.Manager", "JobRole.HumanResources", "JobRole.LaboratoryTechnician",
                                         "MaritalStatus.Divorced", "MaritalStatus.Single", "MaritalStatus.Married",
                                         "OverTime.Numeric")

categorical.numeric.variables <- c("Education", "EnvironmentSatisfaction", "JobInvolvement", "JobLevel", "JobSatisfaction", "NumCompaniesWorked", "PercentSalaryHike", "TrainingTimesLastYear", "WorkLifeBalance", "YearsAtCompany",  "YearsInCurrentRole", "YearsSinceLastPromotion", "YearsWithCurrManager")

continious.numeric.variables <- c("Age", "DailyRate", "DistanceFromHome", "EmployeeNumber", "HourlyRate", "MonthlyIncome", "MonthlyRate")

all.variables <- c(categorical.string.variables, categorical.numeric.variables, continious.numeric.variables)

all.evaluation.variables <- c(categorical.string.variables,
                              c("Education.Quartiles", "EnvironmentSatisfaction.Quartiles", "JobInvolvement.Quartiles", "JobLevel.Quartiles", "JobSatisfaction.Quartiles", "NumCompaniesWorked.Quartiles", "PercentSalaryHike.Quartiles", "TrainingTimesLastYear.Quartiles", "WorkLifeBalance.Quartiles", "YearsAtCompany.Quartiles",  "YearsInCurrentRole.Quartiles", "YearsSinceLastPromotion.Quartiles", "YearsWithCurrManager.Quartiles"),
                              c("Age.Quartiles", "DailyRate.Quartiles", "DistanceFromHome.Quartiles", "EmployeeNumber.Quartiles", "HourlyRate.Quartiles", "MonthlyIncome.Quartiles", "MonthlyRate.Quartiles")
                              )


# Calculate and Record Quartiles for All Numeric Variables
for (i in 1:length(categorical.numeric.variables)) { 
  employee.dB[ ,paste0(categorical.numeric.variables[i],".Quartiles") ] <- cut(employee.dB[ ,categorical.numeric.variables[i]], 4, include.lowest = TRUE, labels = c("0-25%", "25-50%", "50-75%", "75-100%"))
}

for (i in 1:length(continious.numeric.variables)) { 
  employee.dB[ ,paste0(continious.numeric.variables[i],".Quartiles") ] <- cut(employee.dB[ ,continious.numeric.variables[i]], 4, include.lowest = TRUE, labels = c("0-25%", "25-50%", "50-75%", "75-100%"))
}
```

## Calculate Attribute densities & correlations for total, retained employees, lost employee populations
```{r}
# Calculate Attrition Rate by Category - For All & Retained & Lost
categories.dB <- data.frame()

for (i in 1:length(all.evaluation.variables)) {
  #
  unique.vector.temp   <-   unique(employee.dB[, c(paste0(all.evaluation.variables[i]))])
  category.vector.temp <-   rep(c(paste0(all.evaluation.variables[i])), times = length(unique.vector.temp)) 
  category.dF.temp <- data.frame(Category = category.vector.temp, Variable = unique.vector.temp)
  #
  categories.dB <- rbind(categories.dB, category.dF.temp)
}

categories.dB$demographic <- paste0(categories.dB$Category," - ", categories.dB$Variable)

retained.employee.dB <- filter(employee.dB, employee.dB$Attrition == "No")
lost.employee.dB <- filter(employee.dB, employee.dB$Attrition == "Yes")

for (i in 1:nrow(categories.dB)) {
  #
  categories.dB$all.demographic.count[i] <- sum( ldply( employee.dB[, categories.dB$Category[i]], function(c) sum(c==categories.dB$Variable[i]) ) )
  
  categories.dB$retained.demographic.count[i] <- sum( ldply( retained.employee.dB[, categories.dB$Category[i]], function(c) sum(c==categories.dB$Variable[i]) ) )
  categories.dB$retained.demographic.density[i] <- categories.dB$retained.demographic.count[i] / nrow(retained.employee.dB)
  
  categories.dB$lost.demographic.count[i] <- sum( ldply( lost.employee.dB[, categories.dB$Category[i]], function(c) sum(c==categories.dB$Variable[i]) ) )
  categories.dB$lost.demographic.density[i] <- categories.dB$lost.demographic.count[i] / nrow(lost.employee.dB)
  #
}
categories.dB$demographic.density.contrast.delta <- categories.dB$lost.demographic.density - categories.dB$retained.demographic.density
categories.dB$demographic.density.contrast.perc <- (categories.dB$demographic.density.contrast.delta / categories.dB$retained.demographic.density) * 100
categories.dB$retention.rate <- categories.dB$retained.demographic.count/categories.dB$all.demographic.count
categories.dB$attrition.rate <- categories.dB$lost.demographic.count/categories.dB$all.demographic.count
#
```

## Calculate Pearson's correlations & Chi-Square Test
```{r}
#
#### Define Numeric Fields to be Used for Correlation Matrix
correlation.matrix.vector <- c(categorical.numeric.variables, continious.numeric.variables, categorical.string.binary.variables)

correlation.mtx.employee.dB <- rcorr(   as.matrix(employee.dB[, c("Attrition.Numeric" ,correlation.matrix.vector)])   )
correlation.mtx.employee.dB.coeff <- correlation.mtx.employee.dB$r
correlation.mtx.employee.dB.p <- correlation.mtx.employee.dB$P

positive.over.correlation.mtx <- data.frame(matrix(nrow = 1, ncol = 3))
colnames(positive.over.correlation.mtx) <- c("Var1", "Var2", "correl.coeff")

negative.over.correlation.mtx <- data.frame(matrix(nrow = 1, ncol = 3))
colnames(negative.over.correlation.mtx) <- c("Var1", "Var2", "correl.coeff")


correlation.threshold <- 0.75

for (i in 1:ncol(correlation.mtx.employee.dB.coeff)) {
  for (j in 1:nrow(correlation.mtx.employee.dB.coeff)) {
    if (correlation.mtx.employee.dB.coeff[j,i] > correlation.threshold) { 
      positive.over.correlation.mtx <- rbind(positive.over.correlation.mtx, c((colnames(correlation.mtx.employee.dB.coeff))[i], (rownames(correlation.mtx.employee.dB.coeff))[j],  correlation.mtx.employee.dB.coeff[j,i]              ))
    }
    if (correlation.mtx.employee.dB.coeff[j,i] < correlation.threshold*-1) { 
      negative.over.correlation.mtx <- rbind(negative.over.correlation.mtx, c((colnames(correlation.mtx.employee.dB.coeff))[i], (rownames(correlation.mtx.employee.dB.coeff))[j],  correlation.mtx.employee.dB.coeff[j,i]              ))
    }
  }
}
positive.over.correlation.mtx <- filter(positive.over.correlation.mtx, positive.over.correlation.mtx$correl.coeff != 1 & !is.na(positive.over.correlation.mtx))
negative.over.correlation.mtx <- filter(negative.over.correlation.mtx, negative.over.correlation.mtx$correl.coeff != 1 & !is.na(negative.over.correlation.mtx))

######################################################################################################################################
################################################### CHI-SQUARED TEST (ATTRITION) ###################################################
######################################################################################################################################
#
employee.dB.chi.sq <- data.frame(Variable = correlation.matrix.vector)

for (i in 1:nrow(employee.dB.chi.sq)) {
  employee.dB.chi.sq$p.value[i] <- chisq.test(employee.dB$Attrition, employee.dB[,correlation.matrix.vector[i]])$p.value
}
influential.variables.chi.sq <- (filter(employee.dB.chi.sq, employee.dB.chi.sq$p.value < 0.05))$Variable

employee.dB.Categorical.Binary.chi.sq <- data.frame(Variable = categorical.string.binary.variables)

for (i in 1:nrow(employee.dB.Categorical.Binary.chi.sq)) {
  employee.dB.Categorical.Binary.chi.sq$p.value[i] <- chisq.test(employee.dB$Attrition, employee.dB[, categorical.string.binary.variables[i]])$p.value
}
#
######################################################################################################################################
################################################### CHI-SQUARED TEST (MONTHLYINCOME) ###################################################
######################################################################################################################################
#
employee.dB.chi.sq.MI <- data.frame(Variable = correlation.matrix.vector)

for (i in 1:nrow(employee.dB.chi.sq.MI)) {
  employee.dB.chi.sq.MI$p.value[i] <- chisq.test(employee.dB$MonthlyIncome, employee.dB[,correlation.matrix.vector[i]])$p.value
}
influential.variables.chi.sq.MI <- (filter(employee.dB.chi.sq.MI, employee.dB.chi.sq.MI$p.value < 0.05))$Variable

employee.dB.Categorical.Binary.chi.sq.MI <- data.frame(Variable = categorical.string.binary.variables)

for (i in 1:nrow(employee.dB.Categorical.Binary.chi.sq.MI)) {
  employee.dB.Categorical.Binary.chi.sq.MI$p.value[i] <- chisq.test(employee.dB$Attrition, employee.dB[, categorical.string.binary.variables[i]])$p.value
}
```

## STEP 1A - EDA - DEFINE PLOT FUNCTIONS
```{r}
continious.histogram.plot.single.variable <- function(x_name, fill_source) {
  #dev.new()
  employee.dB.plot <- employee.dB[, c(paste0(x_name), paste0(fill_source))]
  employee.dB.plot %>% ggplot(aes(x = employee.dB.plot[,1], y = ..density..))+
    theme_bw()+
    geom_histogram(alpha = 0.35, color = "grey80")+
    geom_density(aes(color = employee.dB.plot[,1]), alpha = 0.01, size = 0.85, show.legend = FALSE)+
    labs(x = x_name, fill = "Attrition")
}

continious.histogram.plot <- function(x_name, fill_source) {
  #dev.new()
  employee.dB.plot <- employee.dB[, c(paste0(x_name), paste0(fill_source))]
  employee.dB.plot %>% ggplot(aes(x = employee.dB.plot[,1], y = ..density.., fill = employee.dB.plot[,2]))+
    theme_bw()+
    geom_histogram(position = "dodge", alpha = 0.35, color = "grey80")+
    geom_density(aes(color = employee.dB.plot[,2]), alpha = 0.01, size = 0.85, show.legend = FALSE)+
    labs(x = x_name, fill = "Attrition")
}

categorical.barchart.plot.single.variable <- function(x_name, fill_source) {
  #dev.new()
  employee.dB.plot <- employee.dB[, c(paste0(x_name), paste0(fill_source))]
  
  employee.dB.plot.table.total <- data.frame(table(employee.dB.plot[,2]))
  var1.name <- employee.dB.plot.table.total[1,1]
  var1.freq <- employee.dB.plot.table.total[1,2]
  var2.name <- employee.dB.plot.table.total[2,1]
  var2.freq <- employee.dB.plot.table.total[2,2]
  
  
  employee.dB.plot.table <- table(employee.dB.plot)
  
  employee.dB.plot.table <- data.frame(table(employee.dB.plot))
  for (i in 1:nrow(employee.dB.plot.table)) {
    if (employee.dB.plot.table[i,2] == var1.name) { employee.dB.plot.table$Density[i] <- employee.dB.plot.table$Freq[i] / var1.freq }
    if (employee.dB.plot.table[i,2] == var2.name) { employee.dB.plot.table$Density[i] <- employee.dB.plot.table$Freq[i] / var2.freq }
  }

  employee.dB.plot.table %>% ggplot(aes(x = employee.dB.plot.table[,1], y = Density))+
    theme_bw()+
    geom_bar(stat = "identity", alpha = 0.35, color = "grey80")+
    labs(x = x_name)
}



categorical.barchart.plot <- function(x_name, fill_source) {
  #dev.new()
  employee.dB.plot <- employee.dB[, c(paste0(x_name), paste0(fill_source))]
  
  employee.dB.plot.table.total <- data.frame(table(employee.dB.plot[,2]))
  var1.name <- employee.dB.plot.table.total[1,1]
  var1.freq <- employee.dB.plot.table.total[1,2]
  var2.name <- employee.dB.plot.table.total[2,1]
  var2.freq <- employee.dB.plot.table.total[2,2]
  
  
  employee.dB.plot.table <- table(employee.dB.plot)
  
  employee.dB.plot.table <- data.frame(table(employee.dB.plot))
  for (i in 1:nrow(employee.dB.plot.table)) {
    if (employee.dB.plot.table[i,2] == var1.name) { employee.dB.plot.table$Density[i] <- employee.dB.plot.table$Freq[i] / var1.freq }
    if (employee.dB.plot.table[i,2] == var2.name) { employee.dB.plot.table$Density[i] <- employee.dB.plot.table$Freq[i] / var2.freq }
  }
  
  
  employee.dB.plot.table %>% ggplot(aes(x = employee.dB.plot.table[,1], y = Density, fill = employee.dB.plot.table[,2]))+
    theme_bw()+
    geom_bar(stat = "identity", position = "dodge", alpha = 0.35, color = "grey80")+
    labs(x = x_name, fill = fill_source)
}

continious.scatter.plot <- function(x_name, y_name, fill_source) {
  #dev.new()
  employee.dB.plot <- employee.dB[, c(paste0(x_name), paste0(y_name), paste0(fill_source))]
  employee.dB.plot %>% ggplot(aes(x = employee.dB.plot[,1], y = employee.dB.plot[,2], color = employee.dB.plot[,3]))+
    theme_bw()+
    geom_point(position = "jitter")+
    labs(x = x_name, y = "Attrition", color = "Attrition")
}
```

## STEP 1B - EDA - CREATE VISUALS
```{r}
if (make.eda.plots == "Yes") {
  
  if (column.histograms == "Yes") {
  #
  ##################
  ### CONTINIOUS VARIABLES ###
  ##################
  #
  ## AGE ##
  #continious.histogram.plot.single.variable("Age", "Attrition")
  #continious.histogram.plot("Age", "Attrition")
  
  ## BUSINESS TRAVEL ##
  continious.histogram.plot.single.variable("DailyRate", "Attrition")
  continious.histogram.plot("DailyRate", "Attrition")
  
  ## DISTANCE FROM HOME ##
  continious.histogram.plot.single.variable("DistanceFromHome", "Attrition")
  continious.histogram.plot("DistanceFromHome", "Attrition")
  
  ## EDUCATION ##
  continious.histogram.plot.single.variable("Education", "Attrition")
  continious.histogram.plot("Education", "Attrition")
  
  ## HOURLY RATE ##
  continious.histogram.plot.single.variable("HourlyRate", "Attrition")
  continious.histogram.plot("HourlyRate", "Attrition")
  
  ## MONTHLY INCOME ##
  continious.histogram.plot.single.variable("MonthlyIncome", "Attrition")
  continious.histogram.plot("MonthlyIncome", "Attrition")
  
  ## MONTHLY RATE ##
  continious.histogram.plot.single.variable("MonthlyRate", "Attrition")
  continious.histogram.plot("MonthlyRate", "Attrition")
  
  ## PERCENTAGE SALARY HIKE ##
  continious.histogram.plot.single.variable("PercentSalaryHike", "Attrition")
  continious.histogram.plot("PercentSalaryHike", "Attrition")
  
  ## TOTAL WORKING YEARS ##
  continious.histogram.plot.single.variable("TotalWorkingYears", "Attrition")
  continious.histogram.plot("TotalWorkingYears", "Attrition")
  
  ## YEARS AT COMPANY ##
  continious.histogram.plot.single.variable("YearsAtCompany", "Attrition")
  continious.histogram.plot("YearsAtCompany", "Attrition")
  
  ## YEARS IN CURRENT ROLE ##
  continious.histogram.plot.single.variable("YearsInCurrentRole", "Attrition")
  continious.histogram.plot("YearsInCurrentRole", "Attrition")
  
  
  
  ###################
  ### CATEGORICAL VARIABLES ###
  ###################
  #
  ## RAW ATTRITION ##
  #dev.new()
  employee.dB %>% ggplot(aes(x = Attrition, fill = Attrition))+
    theme_bw()+
    geom_bar(stat = "count", alpha = 0.35, color = "grey80", show.legend = FALSE)+
    labs(x = "Attrition", y = "Count")
  
  ## BUSINESS TRAVEL ##
  categorical.barchart.plot.single.variable("BusinessTravel", "Attrition")
  categorical.barchart.plot("BusinessTravel", "Attrition")
  
  ## DEPARTMENT ##
  categorical.barchart.plot.single.variable("Department", "Attrition")
  categorical.barchart.plot("Department", "Attrition")
  
  #dev.new()
  employee.dB %>% ggplot(aes(x = employee.dB$Department))+
    theme_bw()+
    geom_bar(stat = "count", alpha = 0.35, color = "grey80")+
    labs(x = "Department")
  
  
  ## ENVIRONMENTAL SATISFACTION ##
  categorical.barchart.plot.single.variable("EnvironmentSatisfaction", "Attrition")
  categorical.barchart.plot("EnvironmentSatisfaction", "Attrition")
  
  ## EDUCATION ##
  categorical.barchart.plot.single.variable("Education", "Attrition")
  categorical.barchart.plot("Education", "Attrition")
  
  ## EDUCATION FIELD ##
  categorical.barchart.plot.single.variable("EducationField", "Attrition")
  categorical.barchart.plot("EducationField", "Attrition")
  
  ## ENVIRONMENTAL SATISFACTION  ##
  categorical.barchart.plot.single.variable("EnvironmentSatisfaction", "Attrition")
  categorical.barchart.plot("EnvironmentSatisfaction", "Attrition")
  
  ## GENDER ##
  categorical.barchart.plot.single.variable("Gender", "Attrition")
  categorical.barchart.plot("Gender", "Attrition")
  
  ## JOB INVOLVEMENT ##
  categorical.barchart.plot.single.variable("JobInvolvement", "Attrition")
  categorical.barchart.plot("JobInvolvement", "Attrition")
  
  ## JOB LEVEL ##
  categorical.barchart.plot.single.variable("JobLevel", "Attrition")
  categorical.barchart.plot("JobLevel", "Attrition")
  
  ## JOB ROLE ##
  categorical.barchart.plot.single.variable("JobRole", "Attrition")
  categorical.barchart.plot("JobRole", "Attrition")
  
  ## JOB SATISFACTION ##
  categorical.barchart.plot.single.variable("JobSatisfaction", "Attrition")
  categorical.barchart.plot("JobSatisfaction", "Attrition")
  
  ## MARITAL STATUS ##
  categorical.barchart.plot.single.variable("MaritalStatus", "Attrition")
  categorical.barchart.plot("MaritalStatus", "Attrition")
  
  ## NUMBER OF COMPANIES WORKED ##
  categorical.barchart.plot.single.variable("NumCompaniesWorked", "Attrition")
  categorical.barchart.plot("NumCompaniesWorked", "Attrition")
  
  ## OVERTIME ##
  categorical.barchart.plot.single.variable("OverTime", "Attrition")
  categorical.barchart.plot("OverTime", "Attrition")
  
  ## PERFORMANCE RATING ##
  categorical.barchart.plot.single.variable("PerformanceRating", "Attrition")
  categorical.barchart.plot("PerformanceRating", "Attrition")
  
  ## RELATIONSHIP SATISFACTION ##
  categorical.barchart.plot.single.variable("RelationshipSatisfaction", "Attrition")
  categorical.barchart.plot("RelationshipSatisfaction", "Attrition")
  
  ## STOCK OPTION LEVEL ##
  categorical.barchart.plot.single.variable("StockOptionLevel", "Attrition")
  categorical.barchart.plot("StockOptionLevel", "Attrition")
  
  ## TRAINING TIMES LAST YEAR ##
  categorical.barchart.plot.single.variable("TrainingTimesLastYear", "Attrition")
  categorical.barchart.plot("TrainingTimesLastYear", "Attrition")
  
  ## WORKLIFE BALANCE ##
  categorical.barchart.plot.single.variable("WorkLifeBalance", "Attrition")
  categorical.barchart.plot("WorkLifeBalance", "Attrition")
  
  ## YEARS AT COMPANY ##
  categorical.barchart.plot.single.variable("YearsAtCompany", "Attrition")
  categorical.barchart.plot("YearsAtCompany", "Attrition")
  
  ## YEARS IN CURRENT ROLE  ##
  categorical.barchart.plot.single.variable("YearsInCurrentRole", "Attrition")
  categorical.barchart.plot("YearsInCurrentRole", "Attrition")
  
  ## YEARS SINCE LAST PROMOTION  ##
  categorical.barchart.plot.single.variable("YearsSinceLastPromotion", "Attrition")
  categorical.barchart.plot("YearsSinceLastPromotion", "Attrition")
  
  ## YEARS WITH CURRENT MANAGER  ##
  categorical.barchart.plot.single.variable("YearsWithCurrManager", "Attrition")
  categorical.barchart.plot("YearsWithCurrManager", "Attrition")
  
  #
  ###################
  ### TEMPORAL ###
  ###################
  #
  ## EMPLOYEE NUMBER ##
  continious.scatter.plot("EmployeeNumber", "Attrition.Numeric", "Attrition")
  }

  #
  ###################
  ### DEMOGRAPHICS ###
  ###################
  #
  if (demographics.plots == "Yes") {
  
    ## RETENTION DELTA FOR EACH DEMOGRAPHIC (BARCHART)
    #dev.new()
    categories.dB %>% arrange(desc(categories.dB$demographic.density.contrast.delta)) %>% 
      ggplot(aes(x = reorder(demographic,-demographic.density.contrast.delta), y = demographic.density.contrast.delta, fill = Category ))+
      theme_bw()+
      theme(legend.key.width = unit(0.1,"cm"))+
      theme(legend.key.height = unit(0.2,"cm"))+
      theme(axis.text.x = element_text(size = 0.5))+
      theme(axis.text.x = element_text(angle = 45))+
      theme(legend.title = element_text(size = 1))+
      theme(legend.text = element_text(size = 5))+
      geom_bar(stat = "identity")+
      guides(fill = guide_legend(ncol = 1))+
      labs(x = "Demographic", y = "Population Denisty Delta")
    
    ## RETENTION DELTA FOR EACH DEMOGRAPHIC (BARCHART) - TOP 10
    #dev.new()
    categories.dB %>% arrange(desc(categories.dB$demographic.density.contrast.delta)) %>% head(10) %>%
      ggplot(aes(x = reorder(demographic,-demographic.density.contrast.delta), y = demographic.density.contrast.delta, fill = Category ))+
      theme_bw()+
      theme(legend.key.width = unit(0.1,"cm"))+
      theme(legend.key.height = unit(0.2,"cm"))+
      theme(axis.text.x = element_text(size = 10))+
      #theme(axis.text.x = element_text(angle = 45))+
      theme(legend.title = element_text(size = 1))+
      theme(legend.text = element_text(size = 1))+
      geom_bar(stat = "identity")+
      guides(fill = guide_legend(ncol = 1))+
      labs(x = "Demographic", y = "Demographic Denisty Contrast")
    
    ## RETENTION DELTA FOR EACH DEMOGRAPHIC (BARCHART) - BOTTOM 10
    #dev.new()
    categories.dB %>% arrange(desc(categories.dB$demographic.density.contrast.delta)) %>% tail(10) %>%
      ggplot(aes(x = reorder(demographic,-demographic.density.contrast.delta), y = demographic.density.contrast.delta, fill = Category ))+
      theme_bw()+
      theme(legend.key.width = unit(0.1,"cm"))+
      theme(legend.key.height = unit(0.2,"cm"))+
      theme(axis.text.x = element_text(size = 10))+
      #theme(axis.text.x = element_text(angle = 45))+
      theme(legend.title = element_text(size = 1))+
      theme(legend.text = element_text(size = 1))+
      geom_bar(stat = "identity")+
      guides(fill = guide_legend(ncol = 1))+
      labs(x = "Demographic", y = "Demographic Denisty Contrast")
    
    
    #######################################################################################
    
    ## DELTA PERCENTAGE FOR EACH DEMOGRAPHIC (BARCHART)
    #dev.new()
    categories.dB %>% arrange(desc(categories.dB$demographic.density.contrast.perc)) %>% 
      ggplot(aes(x = reorder(demographic,-demographic.density.contrast.perc), y = demographic.density.contrast.perc, fill = Category ))+
      theme_bw()+
      theme(legend.key.width = unit(0.1,"cm"))+
      theme(legend.key.height = unit(0.2,"cm"))+
      theme(axis.text.x = element_text(size = 0.5))+
      theme(axis.text.x = element_text(angle = 45))+
      theme(legend.title = element_text(size = 1))+
      theme(legend.text = element_text(size = 5))+
      geom_bar(stat = "identity")+
      guides(fill = guide_legend(ncol = 1))+
      labs(x = "Demographic", y = "Population Denisty Delta Percentage (%)")
    
  } #DEMOGRAPHICS CLOSING BRACKETS
  
  #
  ###################
  ### CORRELATION MATRIX ###
  ###################
  #
  if (correlation.matrix.plots == "Yes") {
    #dev.new()
    corrplot(correlation.mtx.employee.dB.coeff, method = "square", type = "upper", order = "FPC", tl.cex = 0.55)
    
    #dev.new()
    palette = colorRampPalette(c("green", "white", "red")) (20)
    heatmap(x = correlation.mtx.employee.dB.coeff, col = palette, symm = TRUE, cexRow = 0.5, cexCol = 0.5, scale = "column")
    
    #dev.new()
    palette = colorRampPalette(c("green", "white", "red")) (20)
    heatmap(x = correlation.mtx.employee.dB.coeff, col = palette, symm = TRUE, Colv = NA, Rowv = NA, cexRow = 0.5, cexCol = 0.5)
    
    #dev.new()
    correlation.mtx.plot <- ggcorr(correlation.mtx.employee.dB.coeff, size = 1.5, label = TRUE, label_size = 2, label_color = "black", nbreaks = 8, label_alpha = TRUE, color = "grey5", layout.exp = 1)
    multiplot(correlation.mtx.plot)
    
    }
#  
} # ALL EDA CLOSING BRACKET
```


## STEP 2 - CLASSIFICATION ANALYSIS
```{r}
alt.employee.dB <- read.csv(path.employee.dB)

attach(alt.employee.dB)

# Explore the raw data set
str(alt.employee.dB)

#Convert characters to factors
alt.employee.dB$Attrition <- as.factor(alt.employee.dB$Attrition)
alt.employee.dB$BusinessTravel <- as.factor(alt.employee.dB$BusinessTravel)
alt.employee.dB$Department <- as.factor(alt.employee.dB$Department)
alt.employee.dB$EducationField <- as.factor(alt.employee.dB$EducationField)
alt.employee.dB$Gender <- as.factor(alt.employee.dB$Gender)
alt.employee.dB$JobRole <- as.factor(alt.employee.dB$JobRole)
alt.employee.dB$MaritalStatus <- as.factor(alt.employee.dB$MaritalStatus)
alt.employee.dB$Over18 <- as.factor(alt.employee.dB$Over18)
alt.employee.dB$OverTime <- as.factor(alt.employee.dB$OverTime)

# Coerce the integer (more or less categorical) variables in to factors 
categorical.variables <- c('RelationshipSatisfaction', 'PerformanceRating', 'WorkLifeBalance', 'JobInvolvement', 'JobSatisfaction', 'JobLevel', 'StockOptionLevel')
alt.employee.dB[,categorical.variables] <- lapply(alt.employee.dB[,categorical.variables] , factor, ordered = TRUE)
str(alt.employee.dB) 

# Calculate the Time an Employee spend at their last job
alt.employee.dB$TimeAtLastJob <- ifelse(alt.employee.dB$NumCompaniesWorked!=0, alt.employee.dB$TotalWorkingYears-alt.employee.dB$YearsAtCompany/alt.employee.dB$NumCompaniesWorked,0)
alt.employee.dB$AgeGroup <- as.factor(
                        ifelse(alt.employee.dB$Age<=30,"Early", ifelse(
                          alt.employee.dB$Age<=43,"Mid","Late"
                        ))
                      )
#convert MonthlyIncome 
alt.employee.dB$MonthlyIncomeGroup <- as.factor(
  ifelse(alt.employee.dB$MonthlyIncome <= 2911,"1st.Quartile", ifelse(
    alt.employee.dB$MonthlyIncome <= 6503,"2nd.Quartile", ifelse(
      alt.employee.dB$MonthlyIncome <= 8379,"3rd.Quartile","4th.Quartile"
    )))
)
#convert  YearsAtCompany
alt.employee.dB$YrsAtCompanyGroup <- as.factor(
  ifelse(alt.employee.dB$YearsAtCompany <= 3,"1st.Quartile", ifelse(
    alt.employee.dB$YearsAtCompany <= 7,"2nd.Quartile", ifelse(
      alt.employee.dB$YearsAtCompany <= 10,"3rd.Quartile","4th.Quartile"
    )))
)
#convert YearsWithCurrManager
alt.employee.dB$YrsWtCurrManagerGroup <- as.factor(
  ifelse(alt.employee.dB$YearsWithCurrManager <= 2,"1st.Quartile", ifelse(
    alt.employee.dB$YearsWithCurrManager <= 4,"2nd.Quartile", ifelse(
      alt.employee.dB$YearsWithCurrManager <= 7,"3rd.Quartile","4th.Quartile"
    )))
)
#convert YearsInCurrentRole
alt.employee.dB$YrsInCurrentRoleGroup <- as.factor(
  ifelse(alt.employee.dB$YearsInCurrentRole <= 2,"LessTh2", ifelse(
    alt.employee.dB$YearsInCurrentRole <= 4,"2nd.Quartile", ifelse(
      alt.employee.dB$YearsInCurrentRole <= 7,"3rd.Quartile","4th.Quartile"
    )))
)

#create a new data frame with factors 
alt.employee.dB_cat = alt.employee.dB[, c(2, 3, 4, 5, 6, 7, 8, 9, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 24, 25, 26, 27, 29, 30, 31, 32, 33, 34, 35, 36,  37, 38)]

#check for missing values
colSums(is.na(alt.employee.dB_cat)) 

#Split the Data
set.seed(1234)
alt.employee.dB_cat_split <- sample.split(alt.employee.dB_cat$Attrition, SplitRatio = 0.70)
alt.employee.dB_cat_train <- subset(alt.employee.dB_cat,alt.employee.dB_cat_split == T)
alt.employee.dB_cat_test <- subset(alt.employee.dB_cat,alt.employee.dB_cat_split == F)

# compare the dimention of splitted dataset
dim(alt.employee.dB_cat)
dim(alt.employee.dB_cat_test)
dim(alt.employee.dB_cat_train) 

################ kNN Classifier ################

#Fit the model on train data
KnnModel <- train(Attrition~.,alt.employee.dB_cat_train,method = 'knn',trControl = trainControl(method = 'repeatedcv',number = 3))
#Predict with test set
Knn_pred <- predict(KnnModel,alt.employee.dB_cat_test)
#Print confusion matrix
Knn_CM <- confusionMatrix(alt.employee.dB_cat_test$Attrition, Knn_pred)
#Plot the curve
plot.roc(as.numeric(alt.employee.dB_cat_test$Attrition), as.numeric(Knn_pred),lwd=4, type="b",grid.lty=3, grid=TRUE, print.auc=TRUE,print.auc.col= "#BEBADA", col ="#BEBADA", main = "K-Nearest Neighbor")

################ Naive Bayes Classifier ################

# Fit the model on train data
NBModel <- naiveBayes(Attrition~., data=alt.employee.dB_cat_train)

# Validate on test set
NBM_pred <- predict(NBModel, newdata=alt.employee.dB_cat_test)

# Print confusion matrix
NBM_CM <- confusionMatrix(NBM_pred, alt.employee.dB_cat_test$Attrition)
NBM_CM
#Plot
NBM_ROC <- plot.roc(as.numeric(alt.employee.dB_cat_test$Attrition), as.numeric(NBM_pred),lwd=4, type="b",grid.lty=3, grid=TRUE, print.auc=TRUE,print.auc.col= "#FF7F00", col ="#FF7F00", main ="Naive Bayes")
NBM_ROC

################ ROC Comaprison ################

#dev.new()
colAUC(cbind(NBM_pred, Knn_pred), alt.employee.dB_cat_test$Attrition, plotROC = TRUE)

########################################################################
################ Generate Outputs for Grading Submission ###############

# Import & Condition Data
path.class.prediction.dB <- "C:\\Users\\dloveday\\Dropbox\\Family\\School\\SMU\\Courses\\Spring 2021\\DS 6306 - Doing Data Science\\Lecture Notes\\Unit 14 and 15 Case Study 2\\CaseStudy2CompSet No Attrition.csv"
class.prediction.dB <- read.csv(path.class.prediction.dB)

categorical.variables <- c('RelationshipSatisfaction', 'PerformanceRating', 'WorkLifeBalance', 'JobInvolvement', 'JobSatisfaction', 'JobLevel', 'StockOptionLevel')
class.prediction.dB[,categorical.variables] <- lapply(class.prediction.dB[,categorical.variables] , factor, ordered = TRUE)

class.prediction.dB$BusinessTravel <- as.factor(class.prediction.dB$BusinessTravel)
class.prediction.dB$Department <- as.factor(class.prediction.dB$Department)
class.prediction.dB$EducationField <- as.factor(class.prediction.dB$EducationField)
class.prediction.dB$Gender <- as.factor(class.prediction.dB$Gender)
class.prediction.dB$JobRole <- as.factor(class.prediction.dB$JobRole)
class.prediction.dB$MaritalStatus <- as.factor(class.prediction.dB$MaritalStatus)
class.prediction.dB$Over18 <- as.factor(class.prediction.dB$Over18)
class.prediction.dB$OverTime <- as.factor(class.prediction.dB$OverTime)

class.prediction.dB$TimeAtLastJob <- ifelse(class.prediction.dB$NumCompaniesWorked!=0, class.prediction.dB$TotalWorkingYears-class.prediction.dB$YearsAtCompany/class.prediction.dB$NumCompaniesWorked,0)

class.prediction.dB$TimeAtLastJob <- ifelse(class.prediction.dB$NumCompaniesWorked!=0, class.prediction.dB$TotalWorkingYears-class.prediction.dB$YearsAtCompany/class.prediction.dB$NumCompaniesWorked,0)
class.prediction.dB$AgeGroup <- as.factor(
  ifelse(class.prediction.dB$Age<=30,"Early", ifelse(
    class.prediction.dB$Age<=43,"Mid","Late"
  ))
)
#convert MonthlyIncome 
class.prediction.dB$MonthlyIncomeGroup <- as.factor(
  ifelse(class.prediction.dB$MonthlyIncome <= 2911,"1st.Quartile", ifelse(
    class.prediction.dB$MonthlyIncome <= 6503,"2nd.Quartile", ifelse(
      class.prediction.dB$MonthlyIncome <= 8379,"3rd.Quartile","4th.Quartile"
    )))
)
#convert  YearsAtCompany
class.prediction.dB$YrsAtCompanyGroup <- as.factor(
  ifelse(class.prediction.dB$YearsAtCompany <= 3,"1st.Quartile", ifelse(
    class.prediction.dB$YearsAtCompany <= 7,"2nd.Quartile", ifelse(
      class.prediction.dB$YearsAtCompany <= 10,"3rd.Quartile","4th.Quartile"
    )))
)
#convert YearsWithCurrManager
class.prediction.dB$YrsWtCurrManagerGroup <- as.factor(
  ifelse(class.prediction.dB$YearsWithCurrManager <= 2,"1st.Quartile", ifelse(
    class.prediction.dB$YearsWithCurrManager <= 4,"2nd.Quartile", ifelse(
      class.prediction.dB$YearsWithCurrManager <= 7,"3rd.Quartile","4th.Quartile"
    )))
)
#convert YearsInCurrentRole
class.prediction.dB$YrsInCurrentRoleGroup <- as.factor(
  ifelse(class.prediction.dB$YearsInCurrentRole <= 2,"LessTh2", ifelse(
    class.prediction.dB$YearsInCurrentRole <= 4,"2nd.Quartile", ifelse(
      class.prediction.dB$YearsInCurrentRole <= 7,"3rd.Quartile","4th.Quartile"
    )))
)


# Make predictions using Test Model
class.prediction.dB$Attrition <- predict(NBModel, newdata=class.prediction.dB)

# Generate Outputs
write.csv(class.prediction.dB[, c("ID", "Attrition")], file.path("C:\\Users\\dloveday\\Dropbox\\Family\\School\\SMU\\Courses\\Spring 2021\\DS 6306 - Doing Data Science\\Lecture Notes\\Unit 14 and 15 Case Study 2\\DL Work\\Outputs for Submission\\","Case2PredictionsLoveday Attrition.csv"), row.names = FALSE)
```

## STEP 3 - MLR ANALYSIS FOR MonthlyIncome
```{r}

# All Integer Variables in Dataset for MLR
employee.dB.integers <- employee.dB %>% select_if(is.integer)
employee.dB.integers <- employee.dB.integers[,c(2:ncol(employee.dB.integers))]

# Statistically Significant (p-value <0.05) Coefficient from Total Integer MLR Output
stat.signif.variables <- c("DistanceFromHome", "JobLevel", "PercentSalaryHike", "TotalWorkingYears", "YearsWithCurrManager", "MonthlyIncome")

subset.variables <- stat.signif.variables

employee.dB.MI <- as.data.frame(employee.dB[, c(subset.variables)])
employee.dB.MI.log <- log(employee.dB.MI)
employee.dB.MI.sqrt <- sqrt(employee.dB.MI)

#dev.new()
featurePlot(x=employee.dB.MI[,1:4], y=employee.dB.MI[,5], plot="pairs", auto.key=list(columns=3))

#dev.new()
ggpairs(employee.dB.MI)
#dev.new()
ggpairs(employee.dB.MI.log)
#dev.new()
ggpairs(employee.dB.MI.sqrt)


#dev.new()
employee.dB.MI %>% ggplot(aes(x = MonthlyIncome, y = JobLevel))+
  geom_point()

#dev.new()
employee.dB.MI %>% ggplot(aes(x = MonthlyIncome, y = YearsAtCompany))+
  theme_bw()+
  geom_point()
#dev.new()
employee.dB.MI %>% ggplot(aes(x = log(MonthlyIncome), y = YearsAtCompany))+
  theme_bw()+
  geom_point()


#dev.new()
employee.dB.MI %>% ggplot(aes(x = MonthlyIncome, y = YearsSinceLastPromotion))+
  theme_bw()+
  geom_point()

############### MLR MODEL BUILDING (USING ALL GIVEN DATA) ###############

# All integer column model
fit1 <- lm(MonthlyIncome ~ Age + DailyRate + DistanceFromHome + Education + EmployeeNumber + EnvironmentSatisfaction + HourlyRate +
             JobInvolvement + JobLevel + JobSatisfaction + MonthlyRate + NumCompaniesWorked + PercentSalaryHike + PerformanceRating +
             RelationshipSatisfaction + StockOptionLevel + TotalWorkingYears + TrainingTimesLastYear + WorkLifeBalance + YearsAtCompany + YearsInCurrentRole +
             YearsSinceLastPromotion + YearsWithCurrManager, data = employee.dB)
summary(fit1)
vif(fit1)
AIC(fit1)
BIC(fit1)
press(fit1)

# Only statistically significant variables
fit2 <- lm(MonthlyIncome ~ DistanceFromHome + JobLevel + PercentSalaryHike + TotalWorkingYears + YearsWithCurrManager, data = employee.dB)
summary(fit2)
vif(fit2)
AIC(fit2)
BIC(fit2)
press(fit2)

fit2b <- lm(MonthlyIncome ~ DistanceFromHome + JobLevel + TotalWorkingYears + YearsWithCurrManager, data = employee.dB)
summary(fit2b)
vif(fit2b)
AIC(fit2b)
BIC(fit2b)
press(fit2b)


# Log
#fit2c <- lm(MonthlyIncome ~ DistanceFromHome + JobLevel + TotalWorkingYears + YearsWithCurrManager, data = employee.dB.MI.log)
#summary(fit2c)
#vif(fit2c)
#AIC(fit2c)
#BIC(fit2c)
#press(fit2c)

# Sqrt
fit2d <- lm(MonthlyIncome ~ DistanceFromHome + JobLevel + TotalWorkingYears + YearsWithCurrManager, data = employee.dB.MI.sqrt)
summary(fit2d)
vif(fit2d)
AIC(fit2d)
BIC(fit2d)
press(fit2d)

# Chi-Squared Impactful Variable Model
fit3 <- lm(MonthlyIncome ~ JobLevel + YearsAtCompany + YearsSinceLastPromotion + YearsWithCurrManager + Age, data = employee.dB)
summary(fit3)
vif(fit3)
AIC(fit3)
BIC(fit3)
press(fit3)

#
Q2_fit_forward <- ols_step_forward_p(fit1, penter = 0.05, details = TRUE)
Q2_fit_backward <- ols_step_backward_p(fit1, penter = 0.05, details = TRUE)
Q2_fit_stepwise <- ols_step_both_p(fit1, penter = 0.05, details = TRUE)

# Stepwise Variable Selection Model
fit4 <- lm(MonthlyIncome ~ JobLevel + TotalWorkingYears + YearsWithCurrManager + DistanceFromHome + EnvironmentSatisfaction, data = employee.dB)
summary(fit4)
vif(fit4)
AIC(fit4)
BIC(fit4)
press(fit4)

############### PREFERRED MLR MODEL TEST & TRAIN ###############

# Build test & train
set.seed(1236)
splitPerc <- 0.70 #Use a 70/30 train to test ratio
trainIndicies <- sample( 1:dim(employee.dB)[1], round(splitPerc * dim(employee.dB)[1]))
train.mlr <- employee.dB[trainIndicies, ]
test.mlr  <- employee.dB[-trainIndicies, ]

# compare the dimention of splitted dataset
dim(employee.dB)
dim(train.mlr)
dim(test.mlr)

#fit.train <- lm(MonthlyIncome ~ DistanceFromHome + JobLevel + PercentSalaryHike + TotalWorkingYears + YearsWithCurrManager, data = train.mlr) # Original Preferred Model before trying Stepwise
fit.train <- lm(MonthlyIncome ~ JobLevel + TotalWorkingYears + YearsWithCurrManager + DistanceFromHome + EnvironmentSatisfaction, data = train.mlr)
summary(fit.train)

test.predict <- predict(fit.train, test.mlr, interval = "confidence")
test.mlr$fit <- test.predict[, "fit"]
test.mlr$MI.res <- test.mlr$MonthlyIncome - test.mlr$fit

#dev.new()
test.mlr %>% ggplot(aes(x = MonthlyIncome, y = MI.res))+
  geom_point()

partial.resid.plot(fit2, smooth.span = 2, lf.col = 2)

### INTERNAL CROSS-VALIDATION of GLM ###

fit2.glm <- glm(MonthlyIncome ~ JobLevel + TotalWorkingYears + YearsWithCurrManager + DistanceFromHome + EnvironmentSatisfaction, data = employee.dB)
cv.err <- cv.glm(employee.dB, fit2.glm)$delta
cv.err.2 <- cv.glm(employee.dB, fit2.glm, K = 2)$delta
cv.err.3 <- cv.glm(employee.dB, fit2.glm, K = 3)$delta
cv.err.6 <- cv.glm(employee.dB, fit2.glm, K = 6)$delta

fit2.cv.lm <- cv.lm(employee.dB, m = 7, plotit = "Observed", form.lm = formula(MonthlyIncome ~ JobLevel + TotalWorkingYears + YearsWithCurrManager + DistanceFromHome + EnvironmentSatisfaction) )


############### PREFERRED MLR MODEL RUN ON BLIND DATASET FOR GRADING SUBMISSION ###############

path.mlr.prediction.dB <- "C:\\Users\\dloveday\\Dropbox\\Family\\School\\SMU\\Courses\\Spring 2021\\DS 6306 - Doing Data Science\\Lecture Notes\\Unit 14 and 15 Case Study 2\\CaseStudy2CompSet No Salary.csv"
mlr.prediction.input.dB <- read.csv(path.mlr.prediction.dB)

mlr.prediction <- predict(fit2, mlr.prediction.input.dB, interval = "confidence")
mlr.prediction.input.dB$MonthlyIncome <- mlr.prediction[, "fit"]

# Compare DistanceFromHome
#dev.new()
plot.JobLevel <-  ggplot()+
                    theme_bw()+
                    geom_point(data = employee.dB, aes(x = MonthlyIncome, y = JobLevel), color = "blue")+
                    geom_point(data = mlr.prediction.input.dB, aes(x = MonthlyIncome, y = JobLevel), color = "red", size = 3, alpha = 0.2)+
                    ggtitle("Job Level - Given vs Prediction")
multiplot(plot.JobLevel)

#dev.new()
plot.DistanceFromHome <-  ggplot()+
                            theme_bw()+
                            geom_point(data = employee.dB, aes(x = MonthlyIncome, y = DistanceFromHome), color = "blue")+
                            geom_point(data = mlr.prediction.input.dB, aes(x = MonthlyIncome, y = DistanceFromHome), color = "red", size = 3, alpha = 0.2)+
                            ggtitle("Distance From Home - Given vs Prediction")
multiplot(plot.DistanceFromHome)

#dev.new()
plot.PercentSalaryHike <-  ggplot()+
                              theme_bw()+
                              geom_point(data = employee.dB, aes(x = MonthlyIncome, y = PercentSalaryHike), color = "blue")+
                              geom_point(data = mlr.prediction.input.dB, aes(x = MonthlyIncome, y = PercentSalaryHike), color = "red", size = 3, alpha = 0.2)+
                              ggtitle("Percent Salary Hike - Given vs Prediction")
multiplot(plot.PercentSalaryHike)

#dev.new()
plot.TotalWorkingYears <-  ggplot()+
                              theme_bw()+
                              geom_point(data = employee.dB, aes(x = MonthlyIncome, y = TotalWorkingYears), color = "blue")+
                              geom_point(data = mlr.prediction.input.dB, aes(x = MonthlyIncome, y = TotalWorkingYears), color = "red", size = 3, alpha = 0.2)+
                              ggtitle("Total Working Years - Given vs Prediction")
multiplot(plot.TotalWorkingYears)

#dev.new()
plot.YearsWithCurrManager <-  ggplot()+
                                theme_bw()+
                                geom_point(data = employee.dB, aes(x = MonthlyIncome, y = YearsWithCurrManager), color = "blue")+
                                geom_point(data = mlr.prediction.input.dB, aes(x = MonthlyIncome, y = YearsWithCurrManager), color = "red", size = 3, alpha = 0.2)+
                                ggtitle("Years With Curr Manager - Given vs Prediction")
multiplot(plot.YearsWithCurrManager)

#dev.new()
plot.EnvironmentSatisfaction <-  ggplot()+
                                    theme_bw()+
                                    geom_point(data = employee.dB, aes(x = MonthlyIncome, y = EnvironmentSatisfaction), color = "blue")+
                                    geom_point(data = mlr.prediction.input.dB, aes(x = MonthlyIncome, y = EnvironmentSatisfaction), color = "red", size = 3, alpha = 0.2)+
                                    ggtitle("Years With Curr Manager - Given vs Prediction")
multiplot(plot.EnvironmentSatisfaction)


# Generate Outputs
mlr.prediction.output.dB <- mlr.prediction.input.dB[, c("ID", "MonthlyIncome")]

write.csv(mlr.prediction.input.dB[, c("ID", "MonthlyIncome")], file.path("C:\\Users\\dloveday\\Dropbox\\Family\\School\\SMU\\Courses\\Spring 2021\\DS 6306 - Doing Data Science\\Lecture Notes\\Unit 14 and 15 Case Study 2\\DL Work\\Outputs for Submission\\","Case2PredictionsLoveday Salary.csv"), row.names = FALSE)
```

## STEP 4 - PRESENTATION GRAPHICS
```{r}
age.quartile.bins <- (max(employee.dB$Age) -  min(employee.dB$Age))/4
age.1st <- min(employee.dB$Age) + age.quartile.bins*1
age.2nd <- min(employee.dB$Age) + age.quartile.bins*2
age.3rd <- min(employee.dB$Age) + age.quartile.bins*3
age.4th <- min(employee.dB$Age) + age.quartile.bins*4


yearscurrentrole.quartile.bins <- (max(employee.dB$YearsInCurrentRole) -  min(employee.dB$YearsInCurrentRole))/4
yearscurrentrole.1st <- min(employee.dB$YearsInCurrentRole) + yearscurrentrole.quartile.bins*1
yearscurrentrole.2nd <- min(employee.dB$YearsInCurrentRole) + yearscurrentrole.quartile.bins*2
yearscurrentrole.3rd <- min(employee.dB$YearsInCurrentRole) + yearscurrentrole.quartile.bins*3
yearscurrentrole.4th <- min(employee.dB$YearsInCurrentRole) + yearscurrentrole.quartile.bins*4


monthlyincome.quartile.bins <- (max(employee.dB$MonthlyIncome) -  min(employee.dB$MonthlyIncome))/4
MonthlyIncome.1st <- min(employee.dB$MonthlyIncome) + monthlyincome.quartile.bins*1
MonthlyIncome.2nd <- min(employee.dB$MonthlyIncome) + monthlyincome.quartile.bins*2
MonthlyIncome.3rd <- min(employee.dB$MonthlyIncome) + monthlyincome.quartile.bins*3
MonthlyIncome.4th <- min(employee.dB$MonthlyIncome) + monthlyincome.quartile.bins*4


yearswithcurrentmanager.quartile.bins <- (max(employee.dB$YearsWithCurrManager) -  min(employee.dB$YearsWithCurrManager))/4
yearswithcurrentmanager.1st <- min(employee.dB$YearsWithCurrManager) + yearswithcurrentmanager.quartile.bins*1
yearswithcurrentmanager.2nd <- min(employee.dB$YearsWithCurrManager) + yearswithcurrentmanager.quartile.bins*2
yearswithcurrentmanager.3rd <- min(employee.dB$YearsWithCurrManager) + yearswithcurrentmanager.quartile.bins*3
yearswithcurrentmanager.4th <- min(employee.dB$YearsWithCurrManager) + yearswithcurrentmanager.quartile.bins*4

environmental.quartile.bins <- (max(employee.dB$EnvironmentSatisfaction) -  min(employee.dB$EnvironmentSatisfaction))/4
environmental.1st <- min(employee.dB$EnvironmentSatisfaction) + environmental.quartile.bins*1
environmental.2nd <- min(employee.dB$EnvironmentSatisfaction) + environmental.quartile.bins*2
environmental.3rd <- min(employee.dB$EnvironmentSatisfaction) + environmental.quartile.bins*3
environmental.4th <- min(employee.dB$EnvironmentSatisfaction) + environmental.quartile.bins*4

############ Visuals ############

# Boxplots of Percentage Salary Hike by Years with Company


temp.plot.melt <- employee.dB[,c("PercentSalaryHike", "YearsAtCompany")]

#dev.new()
temp.plot.melt %>% ggplot(aes(x = YearsAtCompany, y = PercentSalaryHike, group = YearsAtCompany, fill = YearsAtCompany))+
  theme_bw()+
  theme(legend.position="none")+
  geom_boxplot(outlier.shape = NA, alpha = 0.55)+
  geom_dotplot(binaxis='y', stackdir='center', dotsize=0.15, color = "grey55", alpha = 0.1)+
  ylab("Salary Hike (%)")+
  xlab("Years At Company")




# Boxplots of Job Level by Years with Company

temp.plot.melt <- employee.dB[,c("JobLevel", "YearsAtCompany")]

#dev.new()
temp.plot.melt %>% ggplot(aes(x = YearsAtCompany, y = JobLevel, group = YearsAtCompany, fill = YearsAtCompany))+
  theme_bw()+
  theme(legend.position="none")+
  geom_boxplot(outlier.shape = NA, alpha = 0.55)+
  geom_dotplot(binaxis='y', stackdir='center', dotsize=0.15, color = "grey55", alpha = 0.1)+
  ylab("Job Level")+
  xlab("Years At Company")



################## Naive Bayes variable importance

Grid <- data.frame(usekernel = TRUE, laplace = 0, adjust = 1)

mdl <- train(Attrition~., data=alt.employee.dB_cat_train, method = "naive_bayes", trControl=trainControl(method = "none"), tuneGrid=Grid)

mdl.variable.importance <- varImp(mdl)
plot(mdl.variable.importance)
```
